let express,Tablas,jwt,User;_c69‍.x([["default",()=>_c69‍.o]]);_c69‍.w("express",[["default",["express"],function(v){express=v}]]);_c69‍.w("../models/Tablas.js",[["default",["Tablas"],function(v){Tablas=v}]]);_c69‍.w("jsonwebtoken",[["default",["jwt"],function(v){jwt=v}]]);_c69‍.w("../models/user.js",[["default",["User"],function(v){User=v}]]);//aqui van las rutas de todo lo relacionado a tabla






const router = express.Router();

//construccion de los links
router.get("/tabla", async (req,res) => {    
    const tablas = await Tablas.find({});

    res.render("Tablas/tabla", {
        style: 'StyleTabla.css',
        Alltablas: tablas.map((current) => {
            return {
                ID: current.ID,
                Nombre_evento: current.Nombre_evento,
                Fecha_creacion: current.Fecha_creacion,
                Detalle_creacion: current.Detalle_creacion,
                Estado: current.Estado,
                Votar: current.Votar
            };
        }),
    });
});

const tokensValidos = [];

function verificarToken(token, secreto) {
    return new Promise((resolve, reject) => {
      // Verificar la existencia del token en el array
      if (tokensValidos.includes(token)) {
        // Verificar la validez del token
        jwt.verify(token, secreto, (err, decoded) => {
          if (err) {
            // El token no es válido
            reject(err);
          } else {
            // El token es válido
            resolve(decoded);
          }
        });
      } else {
        // El token no existe en el array
        reject('Token no encontrado en la lista de tokens válidos');
      }
    });
  }

router.get("/crearvotacion", async (req,res) =>{
    const cookie = req.cookies["jwt"];
    if(!cookie){
        res.redirect("/login");
        return;
    }
    try {
        const decoded = await verificarToken(token, 'miFirma');
        // Token válido, puedes usar 'decoded' para acceder a los datos del token
        _c69‍.g.console.log('Token válido:', decoded);
            const users = await User.find({});
            res.render("Tablas/crearVotacion",{
                style: 'Stylevotacion.css',
                allUsers : users.map((current) => {
                    return {
                        Name: current.Name,
                        Rut: current.Rut,
                        password: current.password,
                    };
                }),
            });
        
      } catch (error) {
        //Error en la verificación del token
        _c69‍.g.console.error('Error:', error);
        return res.redirect("/login");
      }
});
router.post("/crearvotacion", (req,res) => {
    const tabla = {
        ID: Math.floor(Math.random()*1000) + 1,
        Nombre_evento: req.body.Nombre_evento,
        Fecha_creacion: new Date(), // Establece la fecha actual aquí
        Estado: true,
        Persona1: req.body.Persona1,
        Persona2: req.body.Persona2,
        Persona3: req.body.Persona3,
        voto1: 0,
        voto2: 0,
        voto3: 0,
    };
    Tablas.create(tabla);
    _c69‍.g.console.log("data", tabla);     
    res.render("Tablas/crearVotacion",{
        style: 'Stylevotacion.css',
    });

});

router.get("/tabla/voto/:Nombretabla", async (req,res) => {
    const info = await Tablas.findOne({Nombre_evento: req.params.Nombretabla}).exec();
    res.render("Tablas/Lugarvotacion",{
        style: 'CreacionStyle.css',
        data: info,
    });
});
router.post("/tabla/voto/:Nombre_tabla", async (req,res) => {
    const actualizar = await Tablas.findOne({Nombre_evento: req.params.Nombre_tabla}).exec();
    if(req.body.voto1 === true){
        Tablas.updateOne({
            voto1: actualizar.voto1 + 1
        });
    }
    res.render("Tablas/Lugarvotacion",{
        style: 'CreacionStyle.css',
        data: actualizar,
    });
});

router.get("/tabla/:Nombre_tabla" , async (req,res) => {
    const detalles = await Tablas.findOne({Nombre_evento: 'req.params.Nombre_tabla'});
    res.render("Tablas/detalles_nominacion",{
        style: 'StyleNominacion.css',
        data: detalles
    });
}); 
_c69‍.d(router);